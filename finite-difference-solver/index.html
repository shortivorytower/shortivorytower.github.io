<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Home-brew Backward Parabolic PDE Finite Difference Solver - Short Ivory Tower</title>

<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-P3RGW6V');</script>
<!-- End Google Tag Manager -->


  <!-- Edit site and author settings in `_config.yml` to make the social details your own -->

    <meta content="Short Ivory Tower" property="og:site_name">
  
    <meta content="Home-brew Backward Parabolic PDE Finite Difference Solver" property="og:title">
  
  
    <meta content="article" property="og:type">
  
  
    <meta content="This blog is a place for me to write down technical stuff that I found interesting. 
" property="og:description">
  
  
    <meta content="/finite-difference-solver/" property="og:url">
  
  
    <meta content="2019-01-12T00:00:00+08:00" property="article:published_time">
    <meta content="/about/" property="article:author">
  
  
    <meta content="/assets/img/hk-add-oil.jpg" property="og:image">
  
  
    
  
  
    
    <meta content="Finance" property="article:tag">
    
    <meta content="Mathematics" property="article:tag">
    
  

    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@">
    <meta name="twitter:creator" content="@">
  
    <meta name="twitter:title" content="Home-brew Backward Parabolic PDE Finite Difference Solver">
  
  
    <meta name="twitter:url" content="/finite-difference-solver/">
  
  
    <meta name="twitter:description" content="This blog is a place for me to write down technical stuff that I found interesting. 
">
  
  
    <meta name="twitter:image:src" content="/assets/img/hk-add-oil.jpg">
  

	<meta name="description" content="">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta property="og:image" content="">
	<link rel="shortcut icon" href="/assets/img/favicon/favicon.ico" type="image/x-icon">
	<link rel="apple-touch-icon" href="/assets/img/favicon/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicon/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicon/apple-touch-icon-144x144.png">
	<!-- Chrome, Firefox OS and Opera -->
	<meta name="theme-color" content="#263959">
	<!-- Windows Phone -->
	<meta name="msapplication-navbutton-color" content="#263959">
	<!-- iOS Safari -->
	<meta name="apple-mobile-web-app-status-bar-style" content="#263959">
	<!-- Google Fonts -->
	<link href="https://fonts.googleapis.com/css?family=PT+Serif:400,700" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet">
	<!-- Font Awesome -->
	<link rel="stylesheet" href="/assets/fonts/font-awesome/css/font-awesome.min.css">
	<!-- Styles -->
	<link rel="stylesheet" href="/assets/css/main.css">
</head>

<body>

<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-P3RGW6V"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->


  <div class="wrapper">
    <aside class="sidebar">
  <header>
    <div class="about">
      <div class="cover-author-image">
        <a href="/"><img src="/assets/img/hk-add-oil.jpg" alt="Short Ivory Tower"></a>
      </div>
      <div class="author-name">Short Ivory Tower</div>
      <p>This blog is a notepad to write down technical stuff that I found interesting.</p>
    </div>
  </header> <!-- End Header -->
  <footer>
    <section class="contact">
      <h3 class="contact-title">Contact me</h3>
      <ul>
        
	<!--
          <li><a href="https://twitter.com/artemsheludko_" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>
	-->
        
        
	<!--
          <li><a href="https://facebook.com/" target="_blank"><i class="fa fa-facebook" aria-hidden="true"></i></a></li>
	-->
        
        
          <li class="github"><a href="http://github.com/shortivorytower" target="_blank"><i class="fa fa-github"></i></a></li>
        
        
	<!--
          <li class="linkedin"><a href="https://in.linkedin.com/" target="_blank"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li>
	-->
        
        
	<!--
          <li class="email"><a href="mailto:example.david@blog.com"><i class="fa fa-envelope-o" aria-hidden="true"></i></a></li>
	-->
        
      </ul>
    </section> <!-- End Section Contact -->
    <div class="copyright">
      <p>2019 &copy; Short Ivory Tower</p>
    </div>
  </footer> <!-- End Footer -->
</aside> <!-- End Sidebar -->
<div class="content-box clearfix">
  <article class="article-page">
  <div class="page-content">
    
    
    <div class="wrap-content">
      <header class="header-page">
        <h1 class="page-title">Home-brew Backward Parabolic PDE Finite Difference Solver</h1>
        <div class="page-date"><span>2019, Jan 12&nbsp;&nbsp;&nbsp;&nbsp;</span></div>
      </header>
      <script type="text/x-mathjax-config">
MathJax.Hub.Config({
                  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
                          });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<p>I have a finance related idea which I want to speed up the program by replacing the simulation component with a PDE. I need to solve a PDE that agrees with the <a href="https://en.wikipedia.org/wiki/Feynman%E2%80%93Kac_formula">Feynman-Kac formula</a>.</p>

<p>It is a Parabolic PDE backward in time that looks very similar to the Black Scholes PDE.</p>

<script type="math/tex; mode=display">% <![CDATA[
\begin{align*}

-\frac{\partial V(t, x)}{\partial t} + \mu(t,x) \frac{\partial V(t,x)}{\partial x} + \sigma(t,x) \frac{\partial^2 V(t,x)}{\partial x^2} - r(t,x) V(t,x) & = 0 \\

V(T,x) & = \Psi(x) \\
V(t,x_{min}) &= \ G_{min}(t,x) \\
V(t,x_{max}) &= \ G_{max}(t,x) \\

t & \in [0,T] \\
x & \in [x_{min}, x_{max}] \\

\end{align*} %]]></script>

<p>I want to do it in Python but surprisingly I couldn’t find <b>ANY</b> finite difference solver packages. Almost all packages I’ve found are using Finite Element Methods. I don’t know FEM and I understand that is a more generalized approach for PDEs with very complex domain but for finance related stuff everyone uses finite difference. I better stay with what I know. And that’s why I ended up implemented my own little finite difference PDE solver. This is my first time implementing PDE solvers so I hope I didn’t make any mistake. If there is some other professionally implemented package I would rather use it directly instead of reinventing the wheel.</p>

<p>First we need to treat the numerical PDE solution <script type="math/tex">V(t,x)</script> as a 2D grid. And define a few parameters:</p>

<ul>
  <li><script type="math/tex">Steps_x</script> : Space steps. Number of grid points we have on x-axis including <script type="math/tex">x_{min}</script> and <script type="math/tex">x_{max}</script></li>
  <li><script type="math/tex">Steps_t</script> : Time steps. Number of grid points we have on t-axis including <script type="math/tex">0</script> and <script type="math/tex">T</script>.</li>
  <li><script type="math/tex">\Delta t</script> : Time step size, equals to <script type="math/tex">\frac{T}{Steps_t -1}</script>.</li>
  <li><script type="math/tex">\Delta x</script> : Space step size, equals to <script type="math/tex">\frac{x_{max} - x_{min}}{Steps_x + 1}</script>.</li>
  <li><script type="math/tex">n = 0,1,2 \dots Steps_t -1</script> : t-axis grid index. When <script type="math/tex">n = 0</script>, <script type="math/tex">t=T</script>, and <script type="math/tex">n = Steps_t-1</script> when <script type="math/tex">t=0</script>.</li>
  <li><script type="math/tex">j = 0,1,2 \dots Steps_x -1</script> : x-axis grid index. When <script type="math/tex">j = 0</script>, <script type="math/tex">x=x_{min} + \Delta x</script>, and <script type="math/tex">j</script> is equal to <script type="math/tex">Steps_x-1</script> when <script type="math/tex">x = x_{max} - \Delta x</script>.</li>
</ul>

<p>With the Finite Difference Method we are going to solve the grid values of <script type="math/tex">V^n_j</script> which approximates <script type="math/tex">V(t,x)</script> at every grid point. Doing this backward in time all the way we get the solution at time zero. The picture below illustrates the idea of the algorithm.</p>

<p><img src="/assets/img/pde-solver/pde-solver-grid.png" alt="PDE Solver Grid" class="img-responsive" /></p>

<p>There are a number of different schemes to implement this solver and here I am implementing the <a href="https://en.wikipedia.org/wiki/Crank%E2%80%93Nicolson_method">Crank Nicolson scheme</a>. The idea is that it takes the average values between the time stepping grid points <script type="math/tex">n</script> and <script type="math/tex">n+1</script>. The advantage is that the solution converging in time direction at <script type="math/tex">O(\Delta t^2)</script> whereas simple implicit scheme having only <script type="math/tex">O(\Delta t)</script>. It takes significantly less time steps to get the solution with reasonable accuracy comparing to simple implicit scheme. The down side is that it produces spurious oscillations if there is a jump at the initial boundary <script type="math/tex">\Psi(x)</script>. Here I don’t care since the problem I want to solve does not have this issue.</p>

<p>The approximation of each term under Crank Nicolson scheme:</p>

<script type="math/tex; mode=display">% <![CDATA[
\begin{align*}

V(t,x) & \approx \frac{1}{2}(V^n_j+V^{n+1}_j) \\

\frac{\partial V(t,x)}{\partial t} & \approx \frac{V^{n+1}_j - V^n_j}{\Delta t}\\

\frac{\partial V(t,x)}{\partial x} & \approx \frac{V^n_{j+1} - V^n_{j-1} + V^{n+1}_{j+1} - V^{n+1}_{j-1}}{4 \Delta x} \\

\frac{\partial^2 V(t,x)}{\partial x^2} & \approx \frac{V^n_{j+1} - 2 V^n_j + V^n_{j-1} + V^{n+1}_{j+1} - 2V^{n+1}_j + V^{n+1}_{j-1}}{2 \Delta x^2} \\

\end{align*} %]]></script>

<p>At each grid point we take <script type="math/tex">t = (Steps_t -1 - n) \Delta t</script>, and <script type="math/tex">x = x_{min} + (j+1) \Delta x</script>.</p>

<p>So obviously the functions <script type="math/tex">\mu(t,x)</script>, <script type="math/tex">\sigma(t,x)</script>, and <script type="math/tex">r(t,x)</script> at each grid point would be,</p>

<script type="math/tex; mode=display">% <![CDATA[
\begin{align*}

\mu(t,x) & = \mu((Steps_t -1 - n) \Delta t, x_{min} + (j+1) \Delta x) \\
\sigma(t, x) & = \sigma((Steps_t -1 - n) \Delta t, x_{min} + (j+1) \Delta x) \\
r(t, x) & = r((Steps_t -1 - n) \Delta t, x_{min} + (j+1) \Delta x) 

\tag{1}

\end{align*} %]]></script>

<p>For simplicity I just denote these function values below as <script type="math/tex">\mu</script>, <script type="math/tex">\sigma</script>, and <script type="math/tex">r</script> below.</p>

<p>Substitute all above into the PDE:</p>

<script type="math/tex; mode=display">% <![CDATA[
\begin{align*}

& \frac{-1}{\Delta t} (\color{blue}{V^{n+1}_j} - V^n_j) \\
& + \frac{\mu}{4\Delta x}(V^n_{j+1} - V^n_{j-1} + \color{blue}{V^{n+1}_{j+1}} - \color{blue}{V^{n+1}_{j-1}}) \\
& + \frac{\sigma}{2 \Delta x^2}(V^n_{j+1} - 2 V^n_j + V^n_{j-1} + \color{blue}{V^{n+1}_{j+1}} - 2 \color{blue}{V^{n+1}_j} + \color{blue}{V^{n+1}_{j-1}}) \\
& - \frac{r}{2}(V^n_j + \color{blue}{V^{n+1}_j}) \\ 
& = 0 

\end{align*} %]]></script>

<p>Group all <script type="math/tex">\color{blue}{V^{n+1}}</script> terms to the left and all <script type="math/tex">V^n</script> terms to the right,</p>

<script type="math/tex; mode=display">( \frac{-\mu}{4\Delta x} +\frac{\sigma}{2\Delta x^2}) \color{blue}{V^{n+1}_{j-1}}
+ ( \frac{-1}{\Delta t} - \frac{\sigma}{\Delta x^2} - \frac{r}{2}) \color{blue}{V^{n+1}_j}
+ (\frac{\mu}{4\Delta x} + \frac{\sigma}{2\Delta x^2}) \color{blue}{V^{n+1}_{j+1}}

\\
= 
 ( \frac{\mu}{4 \Delta x} - \frac{\sigma}{2 \Delta x^2}) V^n_{j-1}
+ ( \frac{-1}{\Delta t} + \frac{\sigma}{ \Delta x^2} + \frac{r}{2}) V^n_j
+ ( \frac{-\mu}{4\Delta x} - \frac{\sigma}{2 \Delta x^2}) V^n_{j+1}

\tag{2}</script>

<p>This is the formula expressing the relation of between time step <script type="math/tex">n+1</script> and its previous step <script type="math/tex">n</script>.</p>

<p>At each time step <script type="math/tex">n</script> with known boundary conditions and previous computed values <script type="math/tex">V^n_{j-1}</script>, <script type="math/tex">V^n_j</script>, and <script type="math/tex">V^n_{j+1}</script>.</p>

<p>We can organize the formula (2) above into a system of equations in the matrix form below.
By solving a tri-diagonal matrix inverse we can get all <script type="math/tex">\color{blue}{V^{n+1}_j}</script> values of time step <script type="math/tex">n+1</script>:</p>

<script type="math/tex; mode=display">% <![CDATA[
\begin{pmatrix}
b_0 & c_0 & 0   &  \cdots & \cdots & 0 & 0  \\
a_1 & b_1 & c_1 &  0 & \cdots & 0 & 0  \\
0 & a_2 & b_2 & c_2 & 0 & \cdots & \cdots  \\
\cdots & \cdots & \cdots & \cdots  & \cdots & \cdots & \cdots \\

\cdots & \cdots & \cdots & \cdots & \cdots & \cdots & \cdots \\
0 & 0 & \cdots & 0 & a_{Steps_x-2} & b_{Steps_x-2} & c_{Steps_x-2} \\
0 & 0 & \cdots & \cdots & 0 & a_{Steps_x-1} & b_{Steps_x-1} \\

\end{pmatrix}

\begin{pmatrix}

\color{blue}{V^{n+1}_0} \\
\color{blue}{V^{n+1}_1} \\
\color{blue}{V^{n+1}_2} \\
\vdots \\
\vdots \\

\color{blue}{V^{n+1}_{Steps_x-2}} \\
\color{blue}{V^{n+1}_{Steps_x-1}} \\

\end{pmatrix}

=

\begin{pmatrix}

d_0 \\
d_1 \\
d_2 \\
\vdots \\
\vdots \\
d_{Steps_x-2}\\
d_{Steps_x-1}\\

\end{pmatrix} %]]></script>

<p>For <script type="math/tex">% <![CDATA[
0 < j < Steps_x-1 %]]></script>, we have</p>

<script type="math/tex; mode=display">% <![CDATA[
\begin{align*}

a_j & = \frac{-\mu}{4\Delta x} +\frac{\sigma}{2\Delta x^2} \\
b_j & = \frac{-1}{\Delta t} - \frac{\sigma}{\Delta x^2} - \frac{r}{2} \\
c_j & = \frac{\mu}{4\Delta x} + \frac{\sigma}{2\Delta x^2} \\
d_j & = ( \frac{\mu}{4 \Delta x} - \frac{\sigma}{2 \Delta x^2}) V^n_{j-1}
+ ( \frac{-1}{\Delta t} + \frac{\sigma}{\Delta x^2} + \frac{r}{2}) V^n_j
+ ( \frac{-\mu}{4\Delta x} - \frac{\sigma}{2 \Delta x^2}) V^n_{j+1} \\

\end{align*} %]]></script>

<p>For <script type="math/tex">j = 0</script>, we have the same <script type="math/tex">b_j</script> and <script type="math/tex">c_j</script> formulas but do not have the <script type="math/tex">a_j</script> term, and <script type="math/tex">d_0</script> is,</p>

<script type="math/tex; mode=display">% <![CDATA[
\begin{align*}

d_0 &= ( \frac{\mu}{4 \Delta x} - \frac{\sigma}{2 \Delta x^2}) G_{min}((Steps_t-1-n)\Delta t, x_{min}) \\
&+ ( \frac{-1}{\Delta t} + \frac{\sigma}{\Delta x^2} + \frac{r}{2}) V^n_0 \\
&+ ( \frac{-\mu}{4\Delta x} - \frac{\sigma}{2 \Delta x^2}) V^n_{1} \\
&- (\frac{-\mu}{4\Delta x} +\frac{\sigma}{2\Delta x^2}) G_{min}((Steps_t-1-(n+1))\Delta t, x_{min}) \\

\end{align*} %]]></script>

<p>Similarly for <script type="math/tex">j = Steps_x -1</script>, we have the same <script type="math/tex">a_j</script> and <script type="math/tex">b_j</script> formula but do not have the <script type="math/tex">c_j</script> term, and <script type="math/tex">d_{Steps_x-1}</script> is,</p>

<script type="math/tex; mode=display">% <![CDATA[
\begin{align*}

d_{Steps_x-1} &= ( \frac{\mu}{4 \Delta x} - \frac{\sigma}{2 \Delta x^2}) V^n_{Steps_x-2} \\
&+ ( \frac{-1}{\Delta t} + \frac{\sigma}{\Delta x^2} + \frac{r}{2}) V^n_{Steps_x-1} \\
&+ ( \frac{-\mu}{4\Delta x} - \frac{\sigma}{2 \Delta x^2}) G_{max}((Steps_t-1-n)\Delta t, x_{max}) \\
&- (\frac{\mu}{4\Delta x} + \frac{\sigma}{2\Delta x^2}) G_{max}((Steps_t-1-(n+1))\Delta t, x_{max}) \\

\end{align*} %]]></script>

<p>I implemented the algorithm above, and the <a href="https://en.wikipedia.org/wiki/Tridiagonal_matrix_algorithm">Thomas Algorithm</a> to improve the matrix inverse efficiency. To solve the PDE in this form I just iterate from <script type="math/tex">n=0</script> all the way back to <script type="math/tex">n = Steps_t -1</script> (i.e. <script type="math/tex">t=0</script>) and use linear interpolation to locate the point value of <script type="math/tex">V</script> by any given <script type="math/tex">x_0</script>.</p>

<p>Source Code: <a href="https://gist.github.com/shortivorytower/7ed60ba43865f11ba25e43116ca979b9">pdf_finite_difference_solver.py</a></p>

<p>To verify that I am implementing this correctly, I did a little test to price a simple European Call Option and compared it with the close-form solution.</p>

<script type="math/tex; mode=display">% <![CDATA[
\begin{align*}

r(t,x) & = 0.01 \\
\mu(t,x) &= 0.01x \\
\sigma(t,x) &= \frac{1}{2} (0.4x)^2 \\
T &= 1 \\
\Psi(x) &= (x-5.5)^+ \\
G_{min}(t,x) &= G_{max}(t,x) = e^{-0.01(1-t)} \Psi(x) \\
x_{min} &= 0 \\
x_{max} &= 10 \\
Steps_t &= 50 \\
Steps_x &= 200 \\
x_0 &= 5 \\

\end{align*} %]]></script>

<p>Running my code above produces this print out:</p>

<figure class="highlight"><pre><code class="language-txt" data-lang="txt">PDE solution: 0.6216833084401758
elapse time: 0:00:00.072222
Close Form: 0.6237473713186299</code></pre></figure>

<p>Not close enough for option pricing purpose but good enough for checking the solver implementation. The 3D plot looks smooth and doesn’t have obvious glitches.</p>

<p><img src="/assets/img/pde-solver/pde-solver-plot.png" alt="PDE Solver Plot" class="img-responsive" /></p>

<p>Personally I am not intending to use this to price any options. To really price options, we need the following changes:</p>

<ul>
  <li>The PDE should be in the form of <script type="math/tex">\partial \log x</script> instead of <script type="math/tex">\partial x</script></li>
  <li>The max and min boundary should be defined by the number of +/- <script type="math/tex">\sigma</script> based on the given volatility.</li>
  <li>Paying a lot more attention to the boundaries</li>
  <li>Increase the number of time steps and significantly the number of space steps.</li>
</ul>

<p>It is not too bad as a home-brew Finite Difference PDE solver. Once again if there is any existing professionally implemented Python PDE FDM solver I would like to simply use it to avoid all these hassles.</p>


      <div class="page-footer">
        <div class="page-share">
          <a href="https://twitter.com/intent/tweet?text=Home-brew Backward Parabolic PDE Finite Difference Solver&url=/finite-difference-solver/" title="Share on Twitter" rel="nofollow" target="_blank">Twitter</a>
          <a href="https://facebook.com/sharer.php?u=/finite-difference-solver/" title="Share on Facebook" rel="nofollow" target="_blank">Facebook</a>
          <a href="https://plus.google.com/share?url=/finite-difference-solver/" title="Share on Google+" rel="nofollow" target="_blank">Google+</a>
        </div>
        <div class="page-tag">
          
            <a href="/tags#Finance" class="tag">&#35; Finance</a>
          
            <a href="/tags#Mathematics" class="tag">&#35; Mathematics</a>
          
        </div>
      </div>
      <section class="comment-area">
  <div class="comment-wrapper">
    
    <div id="disqus_thread" class="article-comments"></div>
    <script>
      (function() {
          var d = document, s = d.createElement('script');
          s.src = '//shortivorytower.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    
  </div>
</section> <!-- End Comment Area -->

    </div> <!-- End Wrap Content -->
  </div> <!-- End Page Content -->
</article> <!-- End Article Page -->

</div>

  </div>
  
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', '', 'auto');
  ga('send', 'pageview');
</script> <!-- End Analytics -->

</body>
</html>
